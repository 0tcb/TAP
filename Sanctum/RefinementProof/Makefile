BOOGIEOPT:=/z3opt:smt.RELEVANCY=0 /z3opt:smt.CASE_SPLIT=0 /errorLimit:1
BUILD=build
BASE:=../..
COMMON:=$(BASE)/Common
TAP=$(BASE)/AbstractPlatform
SANCTUM_MMU:=$(BASE)/Sanctum/MMU
SANCTUM_CPU:=$(BASE)/Sanctum/CPU
SANCTUM_HOST:=$(BASE)/Sanctum/Host
SANCTUM_COMMON:=$(BASE)/Sanctum/Common
SANCTUM_MONITOR:=$(BASE)/Sanctum/Monitor
SANCTUM_UTILS:=$(BASE)/Sanctum/Utils
TEMPLATES:=./Templates

COMMON_FILES=$(COMMON)/Types.bpl $(COMMON)/Common.bpl $(COMMON)/Cache.bpl
SANCTUM_COMMON_FILES=$(SANCTUM_COMMON)/Machine.bpl \
		     $(SANCTUM_COMMON)/Prelude.bpl \
		     $(SANCTUM_COMMON)/Types.bpl
SANCTUM_UTIL_FILES=$(SANCTUM_UTILS)/Utils.bpl
SANCTUM_MMU_FILES=$(SANCTUM_MMU)/MMU.bpl $(SANCTUM_MMU)/Common/Common.bpl
SANCTUM_CPU_FILES=$(SANCTUM_CPU)/CPU.bpl
ABSTRACT_RISCV_MMU=$(SANCTUM_MMU_FILES) $(SANCTUM_MMU)/AbstractSanctumMMU/AbstractRISCVMMU/AbstractRISCVMMU.bpl
ABSTRACT_SANCTUM_MMU=$(ABSTRACT_RISCV_MMU) $(SANCTUM_MMU)/AbstractSanctumMMU/AbstractSanctumMMU.bpl
SANCTUM_MONITOR_FILES=$(SANCTUM_MONITOR)/Monitor.bpl $(SANCTUM_MONITOR)/MeasurementHelper.bpl
SANCTUM_FILES = $(SANCTUM_COMMON_FILES) $(SANCTUM_UTIL_FILES) $(ABSTRACT_SANCTUM_MMU) $(SANCTUM_CPU_FILES) $(SANCTUM_MONITOR_FILES)
#
# common files
REFINEMENT_FILES = RefinementCommon.bpl 
TAP_FILES = $(TAP)/CPU.bpl $(TAP)/Types.bpl

# refinements.
INIT_REFINEMENT:=InitRefinement.bpl
SANCTUM_REFINEMENT:=SanctumRefinement.bpl
LOAD_STORE_REFINEMENT:=LoadStore.bpl
MONITOR_REFINEMENT:=Monitor.bpl
ENCLAVE_ENTRY_EXIT_REFINEMENT:=EnclaveEntryExit.bpl
ENCLAVE_LAUNCH_DESTROY_REFINEMENT:=EnclaveLaunchDestroy.bpl
# implementations
INIT_IMPL:=InitImpl.bpl
LOAD_STORE_IMPL:=LoadStoreImpl.bpl
MONITOR_IMPL:=MonitorImpl.bpl
ENCLAVE_ENTRY_EXIT_IMPL:=EnclaveEntryExitImpl.bpl
ENCLAVE_LAUNCH_DESTROY_IMPL:=EnclaveLaunchDestroyImpl.bpl
# templates.
INIT_TEMPLATE:=$(TEMPLATES)/InitRefinement.bpl
SANCTUM_TEMPLATE:=$(TEMPLATES)/SanctumRefinement.bpl
LOAD_STORE_TEMPLATE:=$(TEMPLATES)/LoadStore.bpl
MONITOR_TEMPLATE=$(TEMPLATES)/Monitor.bpl
ENCLAVE_ENTRY_EXIT_TEMPLATE=$(TEMPLATES)/EnclaveEntryExit.bpl
ENCLAVE_LAUNCH_DESTROY_TEMPLATE=$(TEMPLATES)/EnclaveLaunchDestroy.bpl
# proofs.
INIT_PROOF:=$(BUILD)/InitRefinement.xml
SANCTUM_REFINEMENT_PROOF:=$(BUILD)/SanctumRefinement.xml
LOAD_STORE_PROOF=$(BUILD)/LoadStoreProof.xml
MONITOR_PROOF=$(BUILD)/MonitorProof.xml
ENCLAVE_ENTRY_EXIT_PROOF=$(BUILD)/EnclaveEntryExit.xml
ENCLAVE_LAUNCH_DESTROY_PROOF=$(BUILD)/EnclaveLaunchDestroy.xml

all: $(INIT_PROOF) $(LOAD_STORE_PROOF) $(MONITOR_PROOF) $(ENCLAVE_ENTRY_EXIT_PROOF) $(ENCLAVE_LAUNCH_DESTROY_PROOF)

# Generate proofs scripts from templates.
$(SANCTUM_REFINEMENT): $(SANCTUM_TEMPLATE) $(TEMPLATES)/RefinementRelation.bpl $(TEMPLATES)/processtemplate.py
	python3 $(TEMPLATES)/processtemplate.py --template=$(TEMPLATES)/RefinementRelation.bpl $(SANCTUM_TEMPLATE) $(SANCTUM_REFINEMENT)
$(INIT_REFINEMENT): $(INIT_TEMPLATE) $(TEMPLATES)/RefinementRelation.bpl $(TEMPLATES)/processtemplate.py
	python3 $(TEMPLATES)/processtemplate.py --template=$(TEMPLATES)/RefinementRelation.bpl $(INIT_TEMPLATE) $(INIT_REFINEMENT)
$(LOAD_STORE_REFINEMENT): $(LOAD_STORE_TEMPLATE) $(TEMPLATES)/RefinementRelation.bpl $(TEMPLATES)/processtemplate.py
	python3 $(TEMPLATES)/processtemplate.py --template=$(TEMPLATES)/RefinementRelation.bpl $(LOAD_STORE_TEMPLATE) $(LOAD_STORE_REFINEMENT)
$(MONITOR_REFINEMENT): $(MONITOR_TEMPLATE) $(TEMPLATES)/RefinementRelation.bpl $(TEMPLATES)/processtemplate.py
	python3 $(TEMPLATES)/processtemplate.py --template=$(TEMPLATES)/RefinementRelation.bpl $(MONITOR_TEMPLATE) $(MONITOR_REFINEMENT)
$(ENCLAVE_ENTRY_EXIT_REFINEMENT): $(ENCLAVE_ENTRY_EXIT_TEMPLATE) $(TEMPLATES)/RefinementRelation.bpl $(TEMPLATES)/processtemplate.py
	python3 $(TEMPLATES)/processtemplate.py --template=$(TEMPLATES)/RefinementRelation.bpl $(ENCLAVE_ENTRY_EXIT_TEMPLATE) $(ENCLAVE_ENTRY_EXIT_REFINEMENT)
$(ENCLAVE_LAUNCH_DESTROY_REFINEMENT): $(ENCLAVE_LAUNCH_DESTROY_TEMPLATE) $(TEMPLATES)/RefinementRelation.bpl $(TEMPLATES)/processtemplate.py
	python3 $(TEMPLATES)/processtemplate.py --template=$(TEMPLATES)/RefinementRelation.bpl $(ENCLAVE_LAUNCH_DESTROY_TEMPLATE) $(ENCLAVE_LAUNCH_DESTROY_REFINEMENT)

# Execute proof scripts.
$(SANCTUM_REFINEMENT_PROOF): $(COMMON_FILES) $(SANCTUM_FILES) $(TAP_FILES) $(REFINEMENT_FILES) $(SANCTUM_REFINEMENT) $(LOAD_STORE_REFINEMENT) $(MONITOR_REFINEMENT) $(ENCLAVE_ENTRY_EXIT_REFINEMENT) $(ENCLAVE_LAUNCH_DESTROY_REFINEMENT)
	$(BOOGIE) $(BOOGIEOPT) /xml:$@ $^
$(INIT_PROOF): $(COMMON_FILES) $(SANCTUM_FILES) $(TAP_FILES) $(REFINEMENT_FILES) $(INIT_REFINEMENT) $(INIT_IMPL)
	$(BOOGIE) $(BOOGIEOPT) /xml:$@ $^
$(LOAD_STORE_PROOF): $(COMMON_FILES) $(SANCTUM_FILES) $(TAP_FILES) $(REFINEMENT_FILES) $(LOAD_STORE_REFINEMENT) $(LOAD_STORE_IMPL)
	$(BOOGIE) $(BOOGIEOPT) /xml:$@ $^
$(MONITOR_PROOF): $(COMMON_FILES) $(SANCTUM_FILES) $(TAP_FILES) $(REFINEMENT_FILES) $(MONITOR_REFINEMENT) $(MONITOR_IMPL)
	$(BOOGIE) $(BOOGIEOPT) /xml:$@ $^
$(ENCLAVE_ENTRY_EXIT_PROOF): $(COMMON_FILES) $(SANCTUM_FILES) $(TAP_FILES) $(REFINEMENT_FILES) $(ENCLAVE_ENTRY_EXIT_REFINEMENT) $(ENCLAVE_ENTRY_EXIT_IMPL)
	$(BOOGIE) $(BOOGIEOPT) /xml:$@ $^
$(ENCLAVE_LAUNCH_DESTROY_PROOF): $(COMMON_FILES) $(SANCTUM_FILES) $(TAP_FILES) $(REFINEMENT_FILES) $(ENCLAVE_LAUNCH_DESTROY_REFINEMENT) $(ENCLAVE_LAUNCH_DESTROY_IMPL)
	$(BOOGIE) $(BOOGIEOPT) /xml:$@ $^
clean:
	rm -f $(BUILD)/*.xml

.PHONY: clean
